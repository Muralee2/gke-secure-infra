name: Deploy Infra to GCP

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          version: 'latest'

      - name: Create GCP service account key file
        run: |
          cat <<EOF > gcp-key.json
          {
            "type": "service_account",
            "project_id": "${{ secrets.GCP_PROJECT_ID }}",
            "private_key_id": "${{ secrets.GCP_PRIVATE_KEY_ID }}",
            "private_key": "${{ secrets.GCP_PRIVATE_KEY }}",
            "client_email": "${{ secrets.GCP_CLIENT_EMAIL }}",
            "client_id": "${{ secrets.GCP_CLIENT_ID }}",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "${{ secrets.GCP_CLIENT_CERT_URL }}",
            "universe_domain": "googleapis.com"
          }
          EOF

      - name: Authenticate with GCP
        run: gcloud auth activate-service-account --key-file=gcp-key.json

      - name: Set project
        run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      # Replace with your actual deploy step, for example:
      - name: Deploy Terraform
        run: |
          terraform init
          terraform apply -auto-approve
